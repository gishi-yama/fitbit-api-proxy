<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.js"></script>
</head>
<body>
<p>当日0時から24時の山川の心拍数を取得し、グラフ化します。</p>
<p>新しいデータは約15分ごとに自動的に配信されます。</p>
<p>最後にデータが配信されたのは <span id="refreshAt">?</span> です。</p>

<div id="chart"></div>
<button id="btn" onclick="connect()">接続</button>

<script type="text/javascript">

  // 127.0.0.1 の部分は、指示に従って書き換える
  const ep = 'ws://127.0.0.1:8080/edge?gakuseki=b1992490';

  // ボタンを押したときに動く関数
  function connect() {
    // WebSocket通信用を準備する
    const ws = new WebSocket(ep);

    // WebSocket でAPIにアクセスしたときに動く関数
    ws.onopen = function () {
      console.log("open.");
      // ボタン用のHTMLを消す
      const btnTag = document.getElementById('btn');
      btnTag.style.display = 'none';
    };

    // WebSocket から情報が流れてきたときに動く関数
    ws.onmessage = function (evt) {

      // WebSocket から取得した情報を JSON 形式にする
      const jsonData = JSON.parse(evt.data);

      // JSonデータの一番最後の時間を取得して、HTMLの refreshAt に表示する
      const lastOne = jsonData.slice(-1)[0];
      const refreshTag = document.getElementById('refreshAt');
      refreshTag.innerHTML = lastOne.time;

      // グラフを表示する
      c3.generate({
        bindto: '#chart',
        data: {
          json: jsonData,
          keys: {
            x: 'time', value: ['value']
          },
          names: {
            value: '心拍数'
          }
        },
        axis: {
          x: {
            label: {text: '時刻'},
            type: 'category',
            tick: {culling: true, fit: false, width: 200}
          }
        },
        grid: {
          y: {
            lines: [
              {value: 90, text: '↑カロリー燃焼', position: 'start'},
              {value: 56, text: '↓睡眠', position: 'start'}
            ]
          }
        }
      });
    };
  };
</script>
</body>
</html>